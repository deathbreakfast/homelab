version: '3.8'

networks:
  monitoring:
    external: true

services:
{% if prometheus_enabled %}
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "{{ prometheus_port }}:{{ prometheus_port }}"
    volumes:
      - {{ prometheus_data_dir }}:/prometheus
      - {{ prometheus_config_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time={{ prometheus_retention }}'
      - '--web.enable-lifecycle'
    user: "1001:1001"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: {{ prometheus_memory_limit }}
          cpus: '{{ prometheus_cpu_limit }}'
{% endif %}

{% if alertmanager_enabled %}
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "{{ alertmanager_port }}:{{ alertmanager_port }}"
    volumes:
      - {{ alertmanager_data_dir }}:/alertmanager
      - {{ alertmanager_config_dir }}/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:{{ alertmanager_port }}'
    user: "1001:1001"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: {{ alertmanager_memory_limit }}
          cpus: '{{ alertmanager_cpu_limit }}'
{% endif %}


{% if node_exporter_enabled %}
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "{{ node_exporter_port }}:{{ node_exporter_port }}"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    user: "1001:1001"
    networks:
      - monitoring
{% endif %}

{% if docker_exporter_enabled %}
  docker-exporter:
    image: prom/node-exporter:latest
    container_name: docker-exporter
    restart: unless-stopped
    ports:
      - "{{ docker_exporter_port }}:{{ docker_exporter_port }}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - '--collector.docker'
      - '--collector.docker.containers'
      - '--collector.docker.containers.running'
      - '--collector.docker.containers.stopped'
      - '--collector.docker.images'
      - '--collector.docker.info'
    user: "1001:1001"
    networks:
      - monitoring
{% endif %}

{% if blackbox_exporter_enabled %}
  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    restart: unless-stopped
    ports:
      - "{{ blackbox_exporter_port }}:{{ blackbox_exporter_port }}"
    command:
      - '--config.file=/etc/blackbox_exporter/config.yml'
    volumes:
      - {{ blackbox_exporter_config_dir }}/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    user: "1001:1001"
    networks:
      - monitoring
{% endif %}

{% if backup_exporter_enabled %}
  backup-exporter:
    image: python:3.11-alpine
    container_name: backup-exporter
    restart: unless-stopped
    ports:
      - "{{ backup_exporter_port }}:{{ backup_exporter_port }}"
    command:
      - python
      - {{ backup_base_dir }}/backup_exporter.py
      - --backup-dir={{ backup_base_dir }}
      - --rclone-remote={{ rclone_remote }}
      - --port={{ backup_exporter_port }}
    volumes:
      - {{ backup_base_dir }}:{{ backup_base_dir }}:ro
      - /etc/rclone:/etc/rclone:ro
      - /usr/bin/rclone:/usr/bin/rclone:ro
    environment:
      - RCLONE_CONFIG=/etc/rclone/rclone.conf
    user: "1001:1001"
    networks:
      - monitoring
    depends_on:
      - prometheus
{% endif %}
