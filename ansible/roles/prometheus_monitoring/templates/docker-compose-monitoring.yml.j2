version: '3.8'

networks:
  monitoring:
    external: true

services:
{% if prometheus_enabled %}
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "{{ prometheus_port }}:{{ prometheus_port }}"
    volumes:
      - {{ prometheus_data_dir }}:/prometheus
      - {{ prometheus_config_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time={{ prometheus_retention }}'
      - '--web.enable-lifecycle'
    user: "1001:1001"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: {{ prometheus_memory_limit }}
          cpus: '{{ prometheus_cpu_limit }}'
{% endif %}

{% if alertmanager_enabled %}
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "{{ alertmanager_port }}:{{ alertmanager_port }}"
    volumes:
      - {{ alertmanager_data_dir }}:/alertmanager
      - {{ alertmanager_config_dir }}/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:{{ alertmanager_port }}'
    user: "1001:1001"
    networks:
      - monitoring
    deploy:
      resources:
        limits:
          memory: {{ alertmanager_memory_limit }}
          cpus: '{{ alertmanager_cpu_limit }}'
{% endif %}

{% if grafana_monitoring_enabled %}
  grafana-monitoring:
    image: grafana/grafana:latest
    container_name: grafana-monitoring
    restart: unless-stopped
    ports:
      - "{{ grafana_monitoring_port }}:3000"
    volumes:
      - {{ grafana_monitoring_data_dir }}:/var/lib/grafana
      - {{ grafana_monitoring_config_dir }}/grafana.ini:/etc/grafana/grafana.ini
    environment:
      - GF_SECURITY_ADMIN_USER={{ grafana_admin_user }}
      - GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PATHS_DATA=/var/lib/grafana
    user: "1001:1001"
    networks:
      - monitoring
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          memory: {{ grafana_monitoring_memory_limit }}
          cpus: '{{ grafana_monitoring_cpu_limit }}'
{% endif %}

{% if node_exporter_enabled %}
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "{{ node_exporter_port }}:{{ node_exporter_port }}"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    user: "1001:1001"
    networks:
      - monitoring
{% endif %}

{% if docker_exporter_enabled %}
  docker-exporter:
    image: prom/node-exporter:latest
    container_name: docker-exporter
    restart: unless-stopped
    ports:
      - "{{ docker_exporter_port }}:{{ docker_exporter_port }}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - '--collector.docker'
      - '--collector.docker.containers'
      - '--collector.docker.containers.running'
      - '--collector.docker.containers.stopped'
      - '--collector.docker.images'
      - '--collector.docker.info'
    user: "1001:1001"
    networks:
      - monitoring
{% endif %}
