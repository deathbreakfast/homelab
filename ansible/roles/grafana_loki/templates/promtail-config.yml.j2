server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://{{ loki_host }}:{{ loki_port }}/loki/api/v1/push

scrape_configs:
{% if promtail_docker_logs %}
- job_name: docker
  static_configs:
    - targets:
        - localhost
      labels:
        job: docker
        __path__: /var/lib/docker/containers/*/*.log
  pipeline_stages:
    - json:
        expressions:
          output: log
          stream: stream
          attrs:
    - json:
        expressions:
          tag:
        source: attrs
    - regex:
        expression: (?P<container_name>[^|]+)\|
    - timestamp:
        format: RFC3339Nano
        source: time
    - labels:
        stream:
        container_name:
    - output:
        source: output
{% endif %}

{% if promtail_system_logs %}
- job_name: system
  static_configs:
    - targets:
        - localhost
      labels:
        job: system
        __path__: /var/log/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\S+\s+\S+)\s+(?P<hostname>\S+)\s+(?P<service>\S+):\s+(?P<message>.*)'
    - labels:
        hostname:
        service:
    - timestamp:
        format: Jan 02 15:04:05
        source: timestamp
    - output:
        source: message
{% endif %}

{% if promtail_journal_logs %}
- job_name: journal
  journal:
    max_age: 12h
    labels:
      job: systemd-journal
  relabel_configs:
    - source_labels: ['__journal__systemd_unit']
      target_label: 'unit'
    - source_labels: ['__journal__syslog_identifier']
      target_label: 'service'
{% endif %}

{% for log_dir in promtail_log_dirs %}
- job_name: custom_logs_{{ loop.index }}
  static_configs:
    - targets:
        - localhost
      labels:
        job: custom_logs
        __path__: {{ log_dir }}/*.log
  pipeline_stages:
    - regex:
        expression: '^(?P<timestamp>\S+\s+\S+)\s+(?P<level>\S+)\s+(?P<message>.*)'
    - labels:
        level:
    - timestamp:
        format: Jan 02 15:04:05
        source: timestamp
    - output:
        source: message
{% endfor %}
